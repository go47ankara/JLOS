<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>éƒ½é“åºœçœŒã‚¯ã‚¤ã‚ºï¼ˆä¸­ç´šï¼‰</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background-color: #f0f0f0; margin: 0; padding: 10px; }
    h1 { font-size: 1.8em; margin-top: 10px; }
    #question { font-size: 2em; margin: 15px; font-weight: bold; color: #333; }
    #pref-number-display { font-size: 4em; margin: 20px 0; color: #007acc; font-weight: bold; }
    #countdownOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); color: white; font-size: 10vw; display: none; align-items: center; justify-content: center; z-index: 999; }
    #result { font-size: 1.2em; margin-top: 10px; font-weight: bold; }
    #nextBtn { width: 80%; max-width: 300px; font-size: 1em; margin: 8px; padding: 10px; }
    #choices { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
    .choice-button { padding: 10px; font-size: 1em; min-width: 120px; width: 40%; max-width: 200px; }
    img { max-width: 90%; height: auto; margin-top: 20px; }
    #status { font-size: 1.2em; margin-top: 10px; font-weight: bold; }
    #user-info { margin-top: 15px; font-size: 1rem; color: #555; }
    #logout-btn { margin-top: 10px; padding: 0.5rem 1rem; background-color: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; }
    #logout-btn:hover { background-color: #d32f2f; }
    @media (min-width: 600px) { #question { font-size: 2.5em; } #countdownOverlay { font-size: 8vw; } }
  </style>
</head>
<body>
  <h1>éƒ½é“åºœçœŒã‚¯ã‚¤ã‚ºï¼ˆä¸­ç´šï¼‰</h1>
  <p id="question">ã€Œæ¬¡ã®å•é¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
  <button id="nextBtn">æ¬¡ã®å•é¡Œ</button>
  <div id="choices"></div>
  <p id="result"></p>
  <img src="map.png" alt="æ—¥æœ¬åœ°å›³" />
  <div id="pref-number-display"></div>
  <div id="status">
    <p id="timer">ã‚¿ã‚¤ãƒãƒ¼ï¼š--</p>
    <p id="score">ã‚¹ã‚³ã‚¢ï¼š0 / 0å•ä¸­</p>
  </div>
  <div id="user-info">
    <div id="username-display"></div>
    <div id="login-status"></div>
    <button id="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
  <div id="countdownOverlay"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCi3cB7GdpgdEIZrxxnoyHPpeINIJ6sSMw",
      authDomain: "quizapp-jlos.firebaseapp.com",
      projectId: "quizapp-jlos"
    };
    firebase.initializeApp(firebaseConfig);

async function saveScore(level, score) {
  const db = firebase.firestore();
  const auth = firebase.auth();
  const user = auth.currentUser;
  if (!user) return;

  try {
    const uid = user.uid;
    const userRef = db.collection("users").doc(uid);
    const docSnap = await userRef.get();
    const data = docSnap.exists ? docSnap.data() : {};
    const prevMax = data?.stats?.[level]?.maxScore || 0;
    const username = localStorage.getItem("username") || "åŒ¿å";

    // âœ… æ­£ã—ã„ãƒã‚¹ãƒˆæ§‹é€ ã§æ›´æ–°
    const updates = {
      username,
      stats: {
        [level]: {
          tries: firebase.firestore.FieldValue.increment(1),
          totalScore: firebase.firestore.FieldValue.increment(score),
          ...(score > prevMax && { maxScore: score })
        },
        totalScore: firebase.firestore.FieldValue.increment(score),
        totalTries: firebase.firestore.FieldValue.increment(1)
      }
    };

    await userRef.set(updates, { merge: true });
    console.log("âœ… ã‚¹ã‚³ã‚¢ä¿å­˜æˆåŠŸ");
  } catch (e) {
    console.error("âŒ Firestore ä¿å­˜å¤±æ•—:", e);
  }
}

    const prefectures = ["åŒ—æµ·é“", "é’æ£®çœŒ", "å²©æ‰‹çœŒ", "ç§‹ç”°çœŒ", "å®®åŸçœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ", "æ–°æ½ŸçœŒ", "èŒ¨åŸçœŒ", "æ ƒæœ¨çœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "é™å²¡çœŒ", "å¯Œå±±çœŒ", "å²é˜œçœŒ", "æ„›çŸ¥çœŒ", "çŸ³å·çœŒ", "ç¦äº•çœŒ", "æ»‹è³€çœŒ", "ä¸‰é‡çœŒ", "äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ", "å…µåº«çœŒ", "é³¥å–çœŒ", "å²¡å±±çœŒ", "å³¶æ ¹çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ", "é¦™å·çœŒ", "å¾³å³¶çœŒ", "é«˜çŸ¥çœŒ", "æ„›åª›çœŒ", "ç¦å²¡çœŒ", "å¤§åˆ†çœŒ", "ä½è³€çœŒ", "é•·å´çœŒ", "ç†Šæœ¬çœŒ", "å®®å´çœŒ", "é¹¿å…å³¶çœŒ", "æ²–ç¸„çœŒ"];

    const neighbors = {"åŒ—æµ·é“": [], "é’æ£®çœŒ": ["ç§‹ç”°çœŒ", "å²©æ‰‹çœŒ"], "å²©æ‰‹çœŒ": ["é’æ£®çœŒ", "ç§‹ç”°çœŒ", "å®®åŸçœŒ"], "å®®åŸçœŒ": ["å²©æ‰‹çœŒ", "å±±å½¢çœŒ", "ç¦å³¶çœŒ"], "ç§‹ç”°çœŒ": ["é’æ£®çœŒ", "å²©æ‰‹çœŒ", "å±±å½¢çœŒ"], "å±±å½¢çœŒ": ["ç§‹ç”°çœŒ", "å®®åŸçœŒ", "ç¦å³¶çœŒ", "æ–°æ½ŸçœŒ"], "ç¦å³¶çœŒ": ["å®®åŸçœŒ", "å±±å½¢çœŒ", "æ–°æ½ŸçœŒ", "æ ƒæœ¨çœŒ", "èŒ¨åŸçœŒ", "ç¾¤é¦¬çœŒ"], "èŒ¨åŸçœŒ": ["ç¦å³¶çœŒ", "æ ƒæœ¨çœŒ", "åƒè‘‰çœŒ", "åŸ¼ç‰çœŒ"], "æ ƒæœ¨çœŒ": ["ç¦å³¶çœŒ", "ç¾¤é¦¬çœŒ", "èŒ¨åŸçœŒ", "åŸ¼ç‰çœŒ"], "ç¾¤é¦¬çœŒ": ["ç¦å³¶çœŒ", "æ ƒæœ¨çœŒ", "åŸ¼ç‰çœŒ", "é•·é‡çœŒ", "æ–°æ½ŸçœŒ"], "åŸ¼ç‰çœŒ": ["ç¾¤é¦¬çœŒ", "æ ƒæœ¨çœŒ", "èŒ¨åŸçœŒ", "åƒè‘‰çœŒ", "æ±äº¬éƒ½", "å±±æ¢¨çœŒ", "é•·é‡çœŒ"], "åƒè‘‰çœŒ": ["èŒ¨åŸçœŒ", "åŸ¼ç‰çœŒ", "æ±äº¬éƒ½"], "æ±äº¬éƒ½": ["åŸ¼ç‰çœŒ", "åƒè‘‰çœŒ", "ç¥å¥ˆå·çœŒ", "å±±æ¢¨çœŒ"], "ç¥å¥ˆå·çœŒ": ["æ±äº¬éƒ½", "å±±æ¢¨çœŒ", "é™å²¡çœŒ"], "æ–°æ½ŸçœŒ": ["å±±å½¢çœŒ", "ç¦å³¶çœŒ", "ç¾¤é¦¬çœŒ", "é•·é‡çœŒ", "å¯Œå±±çœŒ"], "å¯Œå±±çœŒ": ["æ–°æ½ŸçœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ", "çŸ³å·çœŒ"], "çŸ³å·çœŒ": ["å¯Œå±±çœŒ", "ç¦äº•çœŒ", "å²é˜œçœŒ"], "ç¦äº•çœŒ": ["çŸ³å·çœŒ", "å²é˜œçœŒ", "æ»‹è³€çœŒ", "äº¬éƒ½åºœ"], "å±±æ¢¨çœŒ": ["é•·é‡çœŒ", "åŸ¼ç‰çœŒ", "æ±äº¬éƒ½", "ç¥å¥ˆå·çœŒ", "é™å²¡çœŒ"], "é•·é‡çœŒ": ["æ–°æ½ŸçœŒ", "ç¾¤é¦¬çœŒ", "åŸ¼ç‰çœŒ", "å±±æ¢¨çœŒ", "é™å²¡çœŒ", "å²é˜œçœŒ"], "å²é˜œçœŒ": ["å¯Œå±±çœŒ", "é•·é‡çœŒ", "æ„›çŸ¥çœŒ", "ä¸‰é‡çœŒ", "æ»‹è³€çœŒ", "ç¦äº•çœŒ"], "é™å²¡çœŒ": ["ç¥å¥ˆå·çœŒ", "å±±æ¢¨çœŒ", "é•·é‡çœŒ", "æ„›çŸ¥çœŒ"], "æ„›çŸ¥çœŒ": ["é™å²¡çœŒ", "é•·é‡çœŒ", "å²é˜œçœŒ", "ä¸‰é‡çœŒ"], "ä¸‰é‡çœŒ": ["æ„›çŸ¥çœŒ", "å²é˜œçœŒ", "æ»‹è³€çœŒ", "å¥ˆè‰¯çœŒ", "å’Œæ­Œå±±çœŒ"], "æ»‹è³€çœŒ": ["ç¦äº•çœŒ", "å²é˜œçœŒ", "ä¸‰é‡çœŒ", "äº¬éƒ½åºœ"], "äº¬éƒ½åºœ": ["ç¦äº•çœŒ", "æ»‹è³€çœŒ", "ä¸‰é‡çœŒ", "å¤§é˜ªåºœ", "å¥ˆè‰¯çœŒ", "å…µåº«çœŒ"], "å¤§é˜ªåºœ": ["äº¬éƒ½åºœ", "å¥ˆè‰¯çœŒ", "å…µåº«çœŒ", "å’Œæ­Œå±±çœŒ"], "å…µåº«çœŒ": ["äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "é³¥å–çœŒ", "å²¡å±±çœŒ"], "å¥ˆè‰¯çœŒ": ["äº¬éƒ½åºœ", "å¤§é˜ªåºœ", "ä¸‰é‡çœŒ", "å’Œæ­Œå±±çœŒ"], "å’Œæ­Œå±±çœŒ": ["å¤§é˜ªåºœ", "å¥ˆè‰¯çœŒ", "ä¸‰é‡çœŒ"], "é³¥å–çœŒ": ["å…µåº«çœŒ", "å²¡å±±çœŒ", "å³¶æ ¹çœŒ"], "å³¶æ ¹çœŒ": ["é³¥å–çœŒ", "åºƒå³¶çœŒ", "å±±å£çœŒ"], "å²¡å±±çœŒ": ["å…µåº«çœŒ", "é³¥å–çœŒ", "åºƒå³¶çœŒ"], "åºƒå³¶çœŒ": ["å³¶æ ¹çœŒ", "å²¡å±±çœŒ", "å±±å£çœŒ", "æ„›åª›çœŒ"], "å±±å£çœŒ": ["å³¶æ ¹çœŒ", "åºƒå³¶çœŒ", "ç¦å²¡çœŒ"], "å¾³å³¶çœŒ": ["é¦™å·çœŒ", "é«˜çŸ¥çœŒ", "æ„›åª›çœŒ"], "é¦™å·çœŒ": ["å¾³å³¶çœŒ", "æ„›åª›çœŒ", "å²¡å±±çœŒ"], "æ„›åª›çœŒ": ["é¦™å·çœŒ", "å¾³å³¶çœŒ", "é«˜çŸ¥çœŒ", "åºƒå³¶çœŒ"], "é«˜çŸ¥çœŒ": ["å¾³å³¶çœŒ", "æ„›åª›çœŒ"], "ç¦å²¡çœŒ": ["å±±å£çœŒ", "ä½è³€çœŒ", "å¤§åˆ†çœŒ"], "ä½è³€çœŒ": ["ç¦å²¡çœŒ", "é•·å´çœŒ"], "é•·å´çœŒ": ["ä½è³€çœŒ"], "å¤§åˆ†çœŒ": ["ç¦å²¡çœŒ", "ç†Šæœ¬çœŒ", "å®®å´çœŒ"], "ç†Šæœ¬çœŒ": ["å¤§åˆ†çœŒ", "å®®å´çœŒ", "é¹¿å…å³¶çœŒ", "é•·å´çœŒ"], "å®®å´çœŒ": ["ç†Šæœ¬çœŒ", "å¤§åˆ†çœŒ", "é¹¿å…å³¶çœŒ"], "é¹¿å…å³¶çœŒ": ["å®®å´çœŒ", "ç†Šæœ¬çœŒ"], "æ²–ç¸„çœŒ": [] };

    let currentNumber = null;
    let answerTimer = null;
    let timeLeft = 10;
    let answered = false;
    let score = 0;
    let questionCount = 0;
    const totalQuestions = 10;

    const questionEl = document.getElementById("question");
    const timerEl = document.getElementById("timer");
    const resultEl = document.getElementById("result");
    const nextBtn = document.getElementById("nextBtn");
    const scoreEl = document.getElementById("score");
    const countdownOverlay = document.getElementById("countdownOverlay");
    const choicesDiv = document.getElementById("choices");
    const prefNumberDisplay = document.getElementById("pref-number-display");

    function startCountdown() {
      if (questionCount >= totalQuestions) {
        resultEl.textContent = "ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†æŒ‘æˆ¦ã—ã¦ã­ã€‚";
        return;
      }
      answered = false;
      resultEl.textContent = "";
      countdownOverlay.style.display = "flex";
      choicesDiv.innerHTML = "";
      let count = 3;
      countdownOverlay.textContent = count;
      const countdownTimer = setInterval(() => {
        count--;
        if (count > 0) {
          countdownOverlay.textContent = count;
        } else {
          clearInterval(countdownTimer);
          countdownOverlay.style.display = "none";
          generateQuestion();
        }
      }, 1000);
    }

    function generateQuestion() {
      currentNumber = Math.floor(Math.random() * 47) + 1;
      const correctAnswer = prefectures[currentNumber - 1];
      questionEl.textContent = `å•é¡Œ ${questionCount + 1}: ${currentNumber}ç•ªã®éƒ½é“åºœçœŒã¯ã©ã“ï¼Ÿ`;
      prefNumberDisplay.textContent = `${currentNumber}ç•ª`;
      timeLeft = 10;
      timerEl.textContent = `ã‚¿ã‚¤ãƒãƒ¼ï¼š${timeLeft}ç§’`;

      const candidates = neighbors[correctAnswer] || [];
      const choices = [correctAnswer];
      while (choices.length < 4 && candidates.length > 0) {
        const rand = candidates.splice(Math.floor(Math.random() * candidates.length), 1)[0];
        if (!choices.includes(rand)) choices.push(rand);
      }
      while (choices.length < 4) {
        const rand = prefectures[Math.floor(Math.random() * 47)];
        if (!choices.includes(rand)) choices.push(rand);
      }
      shuffleArray(choices);
      choicesDiv.innerHTML = "";
      choices.forEach(choice => {
        const btn = document.createElement('button');
        btn.textContent = choice;
        btn.className = "choice-button";
        btn.onclick = () => checkAnswer(choice, correctAnswer);
        choicesDiv.appendChild(btn);
      });
      answerTimer = setInterval(() => {
        timeLeft--;
        timerEl.textContent = `ã‚¿ã‚¤ãƒãƒ¼ï¼š${timeLeft}ç§’`;
        if (timeLeft <= 0) {
          clearInterval(answerTimer);
          if (!answered) showTimeoutResult(correctAnswer);
        }
      }, 1000);
    }

    function checkAnswer(selected, correct) {
      if (answered || timeLeft <= 0) return;
      answered = true;
      clearInterval(answerTimer);
      questionCount++;
      if (selected === correct) {
        const point = 1 + timeLeft;
        score += point;
        resultEl.textContent = `æ­£è§£ï¼ğŸ‰ +${point}ç‚¹`;
      } else {
        resultEl.textContent = `ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${correct}ã€ã§ã™ã€‚`;
      }
      scoreEl.textContent = `ã‚¹ã‚³ã‚¢ï¼š${score} / ${questionCount}å•ä¸­`;
      if (questionCount >= totalQuestions) {
        questionEl.textContent = "ã‚²ãƒ¼ãƒ çµ‚äº†ï¼";
        nextBtn.disabled = true;
        firebase.auth().onAuthStateChanged(user => {
          if (user) saveScore("intermediate", score);
          else resultEl.innerHTML += `<br><span style="color:#007acc;">â€» ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å‚åŠ ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</span>`;
        });
      }
    }

    function showTimeoutResult(correct) {
      answered = true;
      questionCount++;
      resultEl.textContent = `â±æ™‚é–“åˆ‡ã‚Œï¼æ­£è§£ã¯ã€Œ${correct}ã€ã§ã—ãŸã€‚`;
      scoreEl.textContent = `ã‚¹ã‚³ã‚¢ï¼š${score} / ${questionCount}å•ä¸­`;
      if (questionCount >= totalQuestions) {
        questionEl.textContent = "ã‚²ãƒ¼ãƒ çµ‚äº†ï¼";
        nextBtn.disabled = true;
        firebase.auth().onAuthStateChanged(user => {
          if (user) saveScore("intermediate", score);
          else resultEl.innerHTML += `<br><span style="color:#007acc;">â€» ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å‚åŠ ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</span>`;
        });
      }
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function handleLogout() {
      localStorage.removeItem('username');
      alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
      window.location.href = 'index.html';
    }

   window.addEventListener("DOMContentLoaded", () => {
      const username = localStorage.getItem("username");
      const usernameDisplay = document.getElementById("username-display");
      const loginStatus = document.getElementById("login-status");
      if (username) {
        usernameDisplay.textContent = `ç™»éŒ²å: ${username}`;
        loginStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";
      } else {
        loginStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“";
      }
      nextBtn.addEventListener("click", startCountdown);
    });
  </script>
</body>
</html>
