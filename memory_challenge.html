
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Êº¢Â≠óË®òÊÜ∂„ÉÅ„É£„É¨„É≥„Ç∏</title>
  <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Shippori Mincho', serif;
      background: #f2f2f2;
      text-align: center;
      padding: 2rem;
    }
    #kanji-display {
      font-size: 20vw;
      margin: 2rem 0 1rem;
      color: #333;
    }
    .choice-button {
      font-size: 1.2rem;
      padding: 0.75rem 1.5rem;
      margin: 0.5rem;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      width: 40%;
    }
    #status-area {
      margin-top: 1.5rem;
      font-size: 1.8rem;
      color: #333;
    }
    #result {
      margin-top: 3rem;
      font-size: 1.5rem;
    }
    table {
      margin: auto;
      background: white;
      border-collapse: collapse;
      box-shadow: 0 0 8px #ccc;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
    }
    th {
      background: #007acc;
      color: white;
    }
    .back-link {
      display: inline-block;
      margin-top: 3rem;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      text-decoration: none;
      color: white;
      background-color: #555;
      border-radius: 6px;
    }
    #start-btn {
      font-size: 1.5rem;
      padding: 1rem 2rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #countdownOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 20vw;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    @media screen and (max-width: 600px) {
      .choice-button {
        width: 80%;
      }
      #kanji-display {
        font-size: 30vw;
      }
    }
  </style>
</head>
<body>
  <h1>Êº¢Â≠óË®òÊÜ∂„ÉÅ„É£„É¨„É≥„Ç∏</h1>
  
<div id="login-status" style="margin-bottom: 1rem; font-weight: bold;"></div>

  <button id="start-btn" onclick="startGame()">„Çπ„Çø„Éº„Éà</button>
  <div id="kanji-display"></div>
  <div id="choices"></div>
  <div id="status-area">
    <div id="score-display">„Çπ„Ç≥„Ç¢: 0 ÁÇπ</div>
    <div id="remaining-display">ÊÆã„Çä: 50 Âïè</div>
  </div>
  <div id="result"></div>
  <h2>„É©„É≥„Ç≠„É≥„Ç∞</h2>
  <table>
    <thead><tr><th>È†Ü‰Ωç</th><th>„É¶„Éº„Ç∂„ÉºÂêç</th><th>„Çπ„Ç≥„Ç¢</th></tr></thead>
    <tbody id="ranking-body"></tbody>
  </table>

  <script type="module">
function handleChoice(correct, basePoint = 0) {
  if (gameEnded) return;
  clearTimeout(timer);
  console.log("üëâ handleChoice called: round", round, "correct:", correct);

  if (round >= 50) {
    console.log("üéØ round >= 50 ‚Üí showFinalResult");
    showFinalResult(score);
    return;
  }

  const elapsed = performance.now() - startTime;
  const bonus = correct ? Math.max(100, Math.floor(2000 - elapsed)) : 0;
  if (correct) score += basePoint + bonus;

  document.getElementById("score-display").textContent = `„Çπ„Ç≥„Ç¢: ${score} ÁÇπ`;

  if (round >= 50) {
    console.log("üéØ (post-increment) round >= 50 ‚Üí showFinalResult");
    showFinalResult(score);
  } else {
    showNextKanji();
  }
}

function createButton(labelObj, isCorrect, forceDarkBlue = false) {
  const btn = document.createElement("button");
  btn.textContent = labelObj.label;
  btn.classList.add("choice-button");

  if (isCorrect) {
    btn.style.backgroundColor = forceDarkBlue
      ? "#004494"
      : (labelObj.color || "#007acc");
  } else {
    btn.style.backgroundColor = "#f0ad4e";
  }

  btn.onclick = () => handleChoice(isCorrect, labelObj.points);
  return btn;
}

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      collection, query, orderBy, limit,
      getDocs, increment
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCi3cB7GdpgdEIZrxxnoyHPpeINIJ6sSMw",
      authDomain: "quizapp-jlos.firebaseapp.com",
      projectId: "quizapp-jlos"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    
const knownLabels = [
  { label: "Ë¶ã„Åü„Åì„Å®„ÅÇ„Çã", points: 100, color: "#cce5ff" },
  { label: "Èü≥Ë™≠„Åø„ÅäÔΩã", points: 200, color: "#66b2ff" },
  { label: "Èü≥Ë®ìÊ•ΩÂãù", points: 200, color: "#4da3ff" },
  { label: "ÁÜüË™û„Åß„Å∞„Å£„Å°„Çä", points: 300, color: "#007bff" },
  { label: "ÂÆåÁíß", points: 300, color: "#004494" }
];

    const unknownLabels = [
  { label: "Ë™≠„ÇÅ„Å™„ÅÑ", points: 0 },
  { label: "„Çè„Åã„Çâ„Çì", points: 0 },
  { label: "Èõ£„Åó„ÅÑ", points: 0 },
  { label: "ÔºüÔºüÔºü", points: 0 },
  { label: "„ÅØÔºü", points: 0 }
];
   
const allKanji = [
    "Êó•","Êúà","Êú®","Â±±","Â∑ù","Áî∞","‰∫∫","Âè£","Ëªä","ÈñÄ","ÁÅ´","Ê∞¥","Èáë","Âúü","Â≠ê","Â•≥","Â≠¶","Áîü","ÂÖà","ÁßÅ",
    "‰∏Ä","‰∫å","‰∏â","Âõõ","‰∫î","ÂÖ≠","‰∏É","ÂÖ´","‰πù","ÂçÅ","Áôæ","ÂçÉ","‰∏á","ÂÜÜ","Âπ¥","‰∏ä","‰∏ã","‰∏≠","Â§ß","Â∞è",
    "Êú¨","Âçä","ÂàÜ","Âäõ","‰Ωï","Êòé","‰ºë","‰Ωì","Â•Ω","Áî∑","Êûó","Ê£Æ","Èñì","Áïë","Â≤©","ÁõÆ","ËÄ≥","Êâã","Ë∂≥","Èõ®",
    "Á´π","Á±≥","Ë≤ù","Áü≥","Á≥∏","Ëä±","Ëå∂","ËÇâ","Êñá","Â≠ó","Áâ©","Áâõ","È¶¨","È≥•","È≠ö","Êñ∞","Âè§","Èï∑","Áü≠","È´ò",
    "ÂÆâ","‰Ωé","Êöó","Â§ö","Â∞ë","Ë°å","Êù•","Â∏∞","È£ü","È£≤","Ë¶ã","ËÅû","Ë™≠","Êõ∏","Ë©±","Ë≤∑","Êïô","Êúù","Êòº","Â§ú",
    "Êô©","Â§ï","Êñπ","Âçà","Ââç","Âæå","ÊØé","ÈÄ±","Êõú","‰Ωú","Ê≥≥","Ê≤π","Êµ∑","ÈÖí","ÂæÖ","Ê†°","ÊôÇ","Ë®Ä","Ë®à","Ë™û",
    "È£Ø","ÂÆÖ","ÂÆ¢","ÂÆ§","ÂÆ∂","Ëã±","Ëñ¨","‰ºö","‰ªä","Èõ™","Èõ≤","Èõª","Â£≤","Â∫É","Â∫ó","Â∫¶","ÁóÖ","Áñ≤","Áóõ","Â±ã",
    "ÂõΩ","Âõû","Âõ∞","Èñã","Èñâ","Ëøë","ÈÅ†","ÈÄü","ÈÅÖ","ÈÅì","Èùí","Êô¥","Èùô","ÂØ∫","ÊåÅ","Ëç∑","Ê≠å","Âèã","Áà∂","ÊØç",
    "ÂÖÑ","Âßâ","Âºü","Â¶π","Â§´","Â¶ª","ÂΩº","‰∏ª","Â••","ÂÖÉ","Ê∞ó","Êúâ","Âêç","Ë¶™","Âàá","‰æø","Âà©","‰∏ç","Ëã•","Êó©",
    "Âøô","Âá∫","ÂÖ•","‰πó","Èôç","ÁùÄ","Ê∏°","ÈÄö","Ëµ∞","Ê≠©","Ê≠¢","Âãï","ÂÉç","Âè≥","Â∑¶","Êù±","Ë•ø","Âåó","Âçó","Â§ñ",
    "ÂÜÖ","ÈÉ®","ÈßÖ","Á§æ","Èô¢","Âú∞","ÈâÑ","Â∑•","Â†¥","Âõ≥","È§®","ÂÖ¨","Âúí","‰Ωè","ÊâÄ","Áï™","Âè∑","Â∏Ç","Áî∫","Êùë",
    "Âå∫","ÈÉΩ","Â∫ú","Áúå","Â≥∂","‰∫¨","Êßò","Á∑¥","Áøí","Âãâ","Âº∑","Á†î","Á©∂","Áïô","Ë≥™","Âïè","È°å","Á≠î","ÂÆø","Êîø",
    "Ê≤ª","Áµå","Ê∏à","Ê≠¥","Âè≤","ËÇ≤","Âåñ","ÁêÜ","Áßë","Êï∞","Âåª","Êò†","Áîª","ÂÜô","Áúü","Èü≥","Ê•Ω","Êñô","ÁµÑ","ÊÄù",
    "Ëâ≤","ÁôΩ","Èªí","Ëµ§","Ëµ∑","ÂØù","ÈÅä","Á´ã","Â∫ß","‰Ωø","Âßã","ÁµÇ","Ë≤∏","ÂÄü","Ëøî","ÈÄÅ","Áµê","Â©ö","Èõ¢","Â∏≠",
    "Ê¨†","‰∫à","ÂÆö","Ê¥ã","Âºè","Âíå","Ê¥ª","Êò•","Â§è","Áßã","ÂÜ¨","Êöë","ÁÜ±","ÂØí","ÂÜ∑","Êöñ","Ê∏©","Ê∂º","Â§©","‰ªï",
    "‰∫ã","ËÄÖ","ÈÅã","Ëª¢","ÈÅ∏","Ë®ò","Ë≠∞","Âì°","ÂïÜ","Ê•≠","Ëæ≤","ËâØ","ÊÇ™","ÁÇπ","Ê≠£","ÈÅï","Âêå","ÈÅ©","ÂΩì","Èõ£",
    "Ê¨°","ÂΩ¢","Âë≥","Ë©¶","È®ì","Èù¢","Êé•","Ë™¨","Êûú","Âêà","Ê†º","Âèó","ËêΩ","Êµ¥","Âøµ","Êåá","Êäò","Êâï","Êäï","Êâì",
    "Ê∑±","Ê¥ó","ÊµÅ","Ê∂à","Ê±∫","ÊóÖ","Á¥Ñ","Ê°à","Ê∫ñ","ÂÇô","Áõ∏","ÊÄ•","ÈÄ£","Áµ°","Ê≥ä","Áâπ","ÊÄ•","Á∑ö","Áô∫","Âà∞",
    "‰∫§","Ê©ü","Èñ¢","Â±Ä","‰ø°","Ë∑Ø","ÊïÖ","Ê≥®","ÊÑè","Êäº","Âºï","Ââ≤","Âñ∂","Ëá™","Áî±","Âèñ","Ê±Ç","È°ò","Áü•","Âè∞",
    "Á™ì","ÂÖ∑","Âô®","Áî®","Êúç","Á¥ô","Ëæû","Èõë","Ë™å","ÈäÄ","Ë≥á","ÂìÅ","ÂÄã","‰æ°","Áî£","Êúü","„ÄÖ","Â†±","Âëä","ÂøÉ",
    "ÊÑü","ÊÉÖ","ÊÇ≤","Ê≥£","Á¨ë","È†≠","Ë¶ö","Âøò","ËÄÉ","‰ºù","‰ª£","Âëº","ÁÑº","Êõ≤","ËÑ±","Âà•","ÈõÜ","‰∏¶","Âñú","È©ö",
    "Á¥∞","Â§™","Èáç","ËªΩ","Áã≠","Âº±","Áú†","Ëã¶","Á∞°","Âçò","Á©∫","Ê∏Ø","È£õ","Èöé","Âª∫","Ë®≠","ÂÆå","Êàê","Ë≤ª","Êîæ",
    "‰Ωç","ÁΩÆ","Ê®™","Âêë","Âéü","Âπ≥","Èáé","È¢®","‰∏°","Ê©ã","ËÄÅ","Êóè","ÈÖç","Ë°ì","ÈÄÄ","Âäπ","Ê∞ë","Ë®™","È°î","Ê≠Ø",
    "Âçí","Ë´ñ","ÂÆü","Ë™ø","ÂøÖ","Ë¶Å","È°û","Âæó","Â§±","Á§º","Â¢ó","Âä†","Ê∏õ","Â§â","Áßª","Á∂ö","ÈÅé","ÈÄ≤","‰ª•","Áæé",
    "ÊØî","ËºÉ","Âèç","ÂØæ","Ë≥õ","ÂÖ±","Áõ¥","Ë°®","Áèæ","Âàù","ÂÖ®","ÊúÄ","ÁÑ°","Èùû","Á¨¨","ÁöÑ","ÊÄß","Ê≥ï","Âà∂","Ë™≤"
]; // ‰ªÆÊº¢Â≠ó„Éá„Éº„Çø

    auth.onAuthStateChanged((user) => {
      const statusDiv = document.getElementById("login-status");
      if (user) {
        const username = localStorage.getItem("username") || "Êú™ÁôªÈå≤„É¶„Éº„Ç∂„Éº";
        statusDiv.innerHTML = `„É≠„Ç∞„Ç§„É≥‰∏≠: <strong>${username}</strong> <button id="logout-btn" style="margin-left: 1rem; padding: 0.3rem 0.6rem;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>`;
        document.getElementById("logout-btn").onclick = () => {
          auth.signOut().then(() => {
            localStorage.removeItem("username");
            location.reload();
          });
        };
      } else {
        statusDiv.innerHTML = `ÁôªÈå≤„Åô„Çå„Å∞„ÄÅÂæóÁÇπ„ÅåË®òÈå≤„Åï„Çå„Åæ„Åô„ÇàÔºÅ <a href="index.html" class="back-link" style="background-color: #007bff;">ÁôªÈå≤„Éª„É≠„Ç∞„Ç§„É≥„ÅØ„Åì„Å°„Çâ</a>`;
      }
    });


    let score = 0;
    let round = 0;
    let used = new Set();
    let startTime;
    let timer;
let gameEnded = false;

    function weightedRandomIndex() {
      const weights = Array(500).fill(1).map((_, i) =>
        i < 100 ? 1 : i < 200 ? 2 : i < 300 ? 3 : i < 400 ? 4 : 5);
      const total = weights.reduce((a, b) => a + b, 0);
      let rand = Math.random() * total;
      for (let i = 0; i < weights.length; i++) {
        if (rand < weights[i]) return i;
        rand -= weights[i];
      }
    }

    

    window.startGame = function () {
  gameEnded = false;
      score = 0;
      round = 0;
      used.clear();
      document.getElementById("score-display").textContent = "„Çπ„Ç≥„Ç¢: 0 ÁÇπ";
      document.getElementById("remaining-display").textContent = "ÊÆã„Çä: 50 Âïè";
      document.getElementById("start-btn").style.display = "none";
      startCountdown(() => showNextKanji());
    };

    function startCountdown(callback) {
      const overlay = document.createElement("div");
      overlay.id = "countdownOverlay";
      document.body.appendChild(overlay);
      let count = 3;
      overlay.textContent = count;
      const interval = setInterval(() => {
        count--;
        if (count > 0) overlay.textContent = count;
        else {
          clearInterval(interval);
          overlay.remove();
          callback();
        }
      }, 1000);
    }

    function showNextKanji() {
  if (round >= 50 || used.size >= allKanji.length) {
    showFinalResult(score);
    return;
  }

  let index;
  do {
    index = weightedRandomIndex();
  } while (used.has(index));
  used.add(index);
  round++;
  const kanji = allKanji[index];
  document.getElementById("kanji-display").textContent = kanji;

  // „ÄåË¶ã„Åü„Åì„Å®„ÅÇ„Çã„Äç„ÅØÂøÖ„ÅöË°®Á§∫
  const mitakotoaru = knownLabels.find(l => l.label === "Ë¶ã„Åü„Åì„Å®„ÅÇ„Çã");

  // „ÄåÂÆåÁíß„Äçor„ÄåÁÜüË™û„Åß„Å∞„Å£„Å°„Çä„Äç„Åã„Çâ„Å©„Å°„Çâ„Åã1„Å§
  const mainChoices = ["ÂÆåÁíß", "ÁÜüË™û„Åß„Å∞„Å£„Å°„Çä"];
  const chosenMain = mainChoices[Math.floor(Math.random() * mainChoices.length)];
  const mainLabelObj = knownLabels.find(l => l.label === chosenMain);

  // „ÄåÂÆåÁíß„Äç„ÄåÁÜüË™û„Åß„Å∞„Å£„Å°„Çä„Äç„ÄåË¶ã„Åü„Åì„Å®„ÅÇ„Çã„Äç‰ª•Â§ñ„Åã„Çâ1„Å§ÈÅ∏„Å∂
  const remainingKnown = knownLabels.filter(
    l => l.label !== "Ë¶ã„Åü„Åì„Å®„ÅÇ„Çã" && l.label !== "ÂÆåÁíß" && l.label !== "ÁÜüË™û„Åß„Å∞„Å£„Å°„Çä"
  );
  const subLabel = remainingKnown.sort(() => 0.5 - Math.random())[0];

  const correctButtons = [
    createButton(mitakotoaru, true),
    createButton(mainLabelObj, true),
    createButton(subLabel, true)
  ];

  const selectedUnknown = unknownLabels[Math.floor(Math.random() * unknownLabels.length)];
  const wrongBtn = createButton(selectedUnknown, false);

  const allBtns = [...correctButtons, wrongBtn].sort(() => 0.5 - Math.random());
  const container = document.getElementById("choices");
  container.innerHTML = "";
  allBtns.forEach(btn => container.appendChild(btn));

  startTime = performance.now();
  timer = setTimeout(() => handleChoice(false, 0), 3000);
  document.getElementById("remaining-display").textContent = `ÊÆã„Çä: ${50 - round} Âïè`;
}



  
async function saveScore(score) {
  const username = localStorage.getItem("username");
  if (!username) {
    console.log("‚ùå No username found, cannot save score");
    return;
  }

  const userRef = doc(db, "users", username);
  const docSnap = await getDoc(userRef);
  const data = docSnap.exists() ? docSnap.data() : {};
  const prevMax = data.memoryScore || 0;
  const totalTries = data.memoryTotal || 0;

  const updates = {
    memoryScore: Math.max(prevMax, score),
    memoryTotal: totalTries + 1
  };

  if (!docSnap.exists()) {
    updates.createdAt = new Date();
    updates.wallet = "";
  }

  console.log("üî• saving score", { username, score, updates });
  await setDoc(userRef, updates, { merge: true });
}

async function showFinalResult(score) {
  gameEnded = true;

  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = `
    <h2>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: ${score} ÁÇπ</h2>
    <button id="retry-btn" style="
      margin-top: 1rem;
      font-size: 1.2rem;
      padding: 0.5rem 1rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    ">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éà„É©„Ç§</button>
  `;
  resultDiv.style.display = "block";

  // üîí Ëß£Á≠î„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
  const allButtons = document.querySelectorAll(".choice-button");
  allButtons.forEach(btn => btn.disabled = true);

  document.getElementById("retry-btn").onclick = startGame;

  await saveScore(score);
  loadAndDisplayTopScores();
}

async function loadAndDisplayTopScores() {
  const rankingBody = document.getElementById("ranking-body");
  rankingBody.innerHTML = "";

  const q = query(
    collection(db, "users"),
    orderBy("memoryScore", "desc"),
    limit(10)
  );

  const querySnapshot = await getDocs(q);
  let rank = 1;
  querySnapshot.forEach((doc) => {
    const data = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${rank}</td><td>${doc.id}</td><td>${data.memoryScore || 0}</td>`;
    rankingBody.appendChild(tr);
    rank++;
  });
}
</script>
</body>
</html>
